<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Años de Servicio</title>
    <!-- Carga de Tailwind CSS para el diseño responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSS personalizado (ubicado aquí para cumplir con el requisito de archivo único) */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffffff; /* Fondo blanco */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        /* Estilo para el encabezado y el pie de página (color verde) */
        .app-header-footer {
            background-color: #10B981; /* Verde esmeralda */
            color: white;
        }
        /* Asegura que el contenido principal ocupe el espacio restante */
        .app-main {
            flex-grow: 1;
        }
        /* Estilo para el icono de calendario en los inputs de fecha */
        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            /* Filtro para cambiar el color del icono a un tono verde */
            filter: invert(0.5) sepia(1) saturate(10) hue-rotate(140deg); 
        }
    </style>
</head>
<body class="selection:bg-emerald-200">

    <!-- Header (Encabezado) -->
    <header class="app-header-footer shadow-lg">
        <div class="max-w-4xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex items-center justify-center space-x-4">
            <!-- Imagen que se puede reemplazar -->
            <img 
                id="header-logo"
                src="imgs/DIRTIC.png"
                alt="Logo reemplazable de la aplicación"
                class="h-11 w-11 sm:h-13 sm:w-13 rounded-full"
            >
            <h1 class="text-3xl font-bold text-center">Calculadora de Años de Servicio</h1>
        </div>
    </header>

    <!-- Main Content (Contenido Principal) -->
    <main class="app-main p-4 sm:p-8">
        <div class="max-w-4xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl border border-gray-100">
            <p class="mb-8 text-center text-gray-600">Ingrese uno o más periodos de servicio para calcular el tiempo total acumulado dentro y/o fuera de la Institución (Años cotizados en AFP, Servicio Militar, etc).</p>

            <!-- Contenedor Dinámico de Periodos -->
            <div id="periodos-container" class="space-y-6">
                <!-- El primer periodo se agregará aquí por JS al cargar -->
            </div>

            <!-- Botones de Acción de Entrada (Agregar Periodo y Calcular) -->
            <div class="flex flex-col sm:flex-row justify-between mt-8 space-y-4 sm:space-y-0 sm:space-x-4">
                <!-- Botón para agregar más periodos -->
                <button onclick="agregarPeriodo()" class="w-full sm:w-1/2 px-6 py-3 border border-emerald-600 text-emerald-600 font-semibold rounded-lg shadow-md hover:bg-emerald-50 focus:outline-none focus:ring-4 focus:ring-emerald-500 focus:ring-opacity-50 transition duration-300 ease-in-out">
                    + Ingresar Otro Periodo
                </button>
                
                <!-- Botón de Cálculo Principal -->
                <button onclick="calcularTiempoDeServicio()" class="w-full sm:w-1/2 px-6 py-3 bg-emerald-600 text-white font-semibold rounded-lg shadow-md hover:bg-emerald-700 focus:outline-none focus:ring-4 focus:ring-emerald-500 focus:ring-opacity-50 transition duration-300 ease-in-out transform hover:scale-[1.01]">
                    Calcular Tiempo Total
                </button>
            </div>

            <!-- Área de Resultados Individuales y Totales -->
            <div id="resultado-container" class="mt-12 space-y-8 hidden">
                <!-- Resultados Individuales se inyectarán aquí -->
                <div id="resultados-individuales" class="space-y-4"></div>
                
                <!-- Resultado Total -->
                <div id="resultado-total" class="p-6 bg-emerald-500 border-l-8 border-emerald-800 rounded-xl shadow-2xl">
                    <!-- El total se inyectará aquí -->
                </div>
            </div>

            <!-- Contenedor de Acciones Post-Cálculo (Solo botón TERMINAR) -->
            <div id="post-calculo-actions" class="mt-8 flex justify-center hidden">
                <!-- Botón de Terminar/Limpiar (Color Rojo) -->
                <button onclick="limpiarPagina()" class="w-full sm:w-1/2 px-6 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-500 focus:ring-opacity-50 transition duration-300 ease-in-out transform hover:scale-[1.01]">
                    TERMINAR
                </button>
            </div>

            <!-- Área de Mensajes de Error -->
            <div id="error-message" class="mt-8 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden" role="alert">
                <!-- Aquí se inyectarán los mensajes de error -->
            </div>

        </div>
    </main>

    <!-- Footer (Pie de Página) -->
    <footer class="app-header-footer mt-auto">
        <div class="max-w-4xl mx-auto py-4 px-4 sm:px-6 lg:px-8">
            <p class="text-center text-sm">&copy; 2026 Área Gestión Recursos Humanos T.I.C. Todos los derechos reservados.</p>
            <p class="text-center text-sm">IP: 22284 - 25260.</p>
        </div>
    </footer>

    <!-- Script de Cálculo y Descarga (JavaScript) -->
    <script>
        let periodoIdCounter = 0;

        // Función auxiliar para obtener el último día del mes anterior
        function getDiasMesAnterior(year, month) {
            return new Date(year, month, 0).getDate();
        }

        /**
         * Calcula la diferencia de tiempo entre dos fechas en años, meses y días.
         * Devuelve un objeto {anos, meses, dias}.
         */
        function calcularDiferencia(fechaInicio, fechaFin) {
            let anos = fechaFin.getFullYear() - fechaInicio.getFullYear();
            let meses = fechaFin.getMonth() - fechaInicio.getMonth();
            let dias = fechaFin.getDate() - fechaInicio.getDate();

            // Ajustar si los días son negativos
            if (dias < 0) {
                meses--;
                dias += getDiasMesAnterior(fechaFin.getFullYear(), fechaFin.getMonth());
            }

            // Ajustar si los meses son negativos
            if (meses < 0) {
                anos--;
                meses += 12;
            }

            return { anos, meses, dias };
        }

        /**
         * Normaliza el tiempo total sumado (convierte 12 meses en 1 año, etc.).
         */
        function normalizarTiempo(totalDias, totalMeses, totalAnos) {
            // Normalización de Días a Meses (usando 30 días como promedio para la suma)
            let mesesExtraD = Math.floor(totalDias / 30);
            totalDias = totalDias % 30;
            totalMeses += mesesExtraD;

            // Normalización de Meses a Años
            let anosExtraM = Math.floor(totalMeses / 12);
            totalMeses = totalMeses % 12;
            totalAnos += anosExtraM;

            return { anos: totalAnos, meses: totalMeses, dias: totalDias };
        }

        /**
         * Genera el HTML para un nuevo periodo de entrada.
         * Se ha eliminado el valor predeterminado del input de nombre.
         */
        function crearPeriodoHTML(id, esInicial = false) {
            periodoIdCounter++;
            const hoy = new Date();
            const fechaActual = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}-${String(hoy.getDate()).padStart(2, '0')}`;
            
            return `
                <div id="periodo-${id}" class="periodo-item p-5 bg-gray-50 rounded-xl shadow-md border border-gray-200">
                    <h4 class="text-lg font-bold text-gray-800 mb-4 flex justify-between items-center">
                        Periodo de Servicio #${id}
                        ${!esInicial ? `<button onclick="eliminarPeriodo(${id})" class="text-red-500 hover:text-red-700 text-sm font-normal transition">Eliminar</button>` : ''}
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Nombre/Descripción del Periodo -->
                        <div class="md:col-span-1">
                            <label for="nombre-periodo-${id}" class="block text-xs font-medium text-gray-600 mb-1">Tipo Contrato (Ej: P.N.S., P.N.I., C.P.R., Otros)</label>
                            <input type="text" id="nombre-periodo-${id}" value="" placeholder="Nombre Opcional" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm text-sm">
                        </div>
                        <!-- Fecha de Ingreso -->
                        <div class="md:col-span-1">
                            <label for="fecha-ingreso-${id}" class="block text-xs font-medium text-gray-600 mb-1">Fecha de Inicio</label>
                            <input type="date" id="fecha-ingreso-${id}" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 text-sm" required>
                        </div>
                        <!-- Fecha de Cálculo (Fin del Periodo) -->
                        <div class="md:col-span-1">
                            <label for="fecha-calculo-${id}" class="block text-xs font-medium text-gray-600 mb-1">Fecha de Término</label>
                            <input type="date" id="fecha-calculo-${id}" value="${esInicial ? fechaActual : ''}" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 text-sm" required>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Añade un nuevo bloque de periodo al DOM.
         */
        function agregarPeriodo(esInicial = false) {
            const container = document.getElementById('periodos-container');
            const newPeriodo = document.createElement('div');
            // Usamos periodoIdCounter + 1 para el ID, y luego incrementamos el contador
            newPeriodo.innerHTML = crearPeriodoHTML(periodoIdCounter + 1, esInicial);
            container.appendChild(newPeriodo.firstElementChild);
        }

        /**
         * Elimina un bloque de periodo del DOM.
         */
        function eliminarPeriodo(id) {
            const periodoElement = document.getElementById(`periodo-${id}`);
            if (periodoElement) {
                periodoElement.remove();
                // Ocultar resultados si no hay periodos restantes
                if (document.querySelectorAll('.periodo-item').length === 0) {
                    document.getElementById('resultado-container').classList.add('hidden');
                    document.getElementById('post-calculo-actions').classList.add('hidden');
                }
            }
        }

        /**
         * Limpia todos los inputs y reinicia la aplicación al estado inicial.
         */
        function limpiarPagina() {
            // 1. Limpiar la tabla de periodos y reinicializar
            const periodosContainer = document.getElementById('periodos-container');
            periodosContainer.innerHTML = '';
            periodoIdCounter = 0; // Resetear contador
            agregarPeriodo(true); // Agregar el primer periodo de nuevo

            // 2. Ocultar contenedores de resultados y botones post-cálculo
            document.getElementById('resultado-container').classList.add('hidden');
            document.getElementById('post-calculo-actions').classList.add('hidden');

            // 3. Limpiar mensajes de error
            const errorDiv = document.getElementById('error-message');
            errorDiv.classList.add('hidden');
            errorDiv.innerHTML = '';

            // 4. Limpiar los resultados internos (aunque se oculten, es buena práctica)
            document.getElementById('resultados-individuales').innerHTML = '';
            document.getElementById('resultado-total').innerHTML = '';
        }


        /**
         * Inicializa la página cargando el primer periodo.
         */
        window.onload = function() {
            agregarPeriodo(true); // Carga el primer periodo al iniciar
        };

        /**
         * Itera sobre todos los periodos y calcula los resultados individuales y totales.
         */
        function calcularTiempoDeServicio() {
            const errorDiv = document.getElementById('error-message');
            const resultadosIndividualesDiv = document.getElementById('resultados-individuales');
            const resultadoTotalDiv = document.getElementById('resultado-total');
            const resultadoContainer = document.getElementById('resultado-container');
            const postCalculoActions = document.getElementById('post-calculo-actions');
            
            // Ocultar resultados y errores anteriores
            errorDiv.classList.add('hidden');
            errorDiv.innerHTML = '';
            resultadosIndividualesDiv.innerHTML = '';
            resultadoTotalDiv.innerHTML = '';
            resultadoContainer.classList.add('hidden');
            postCalculoActions.classList.add('hidden');

            let totalAnos = 0;
            let totalMeses = 0;
            let totalDias = 0;
            let erroresEncontrados = false;
            let resultadosHTML = '<h3 class="text-xl font-bold text-emerald-800 mb-4 border-b pb-2">Resultados por Periodo:</h3>';

            const periodos = document.querySelectorAll('.periodo-item');

            if (periodos.length === 0) {
                 errorDiv.innerHTML = 'Debes ingresar al menos un periodo para realizar el cálculo.';
                 errorDiv.classList.remove('hidden');
                 return;
            }

            periodos.forEach((periodo) => {
                const id = periodo.id.split('-')[1];
                const inputIngreso = document.getElementById(`fecha-ingreso-${id}`).value;
                const inputCalculo = document.getElementById(`fecha-calculo-${id}`).value;
                // Si el nombre está vacío, usa "Periodo sin Nombre" en el resultado.
                const nombrePeriodo = document.getElementById(`nombre-periodo-${id}`).value || 'Periodo sin Nombre'; 

                if (!inputIngreso || !inputCalculo) {
                    // Usar el ID para referenciar el periodo en caso de error si no tiene nombre
                    const nombreRef = document.getElementById(`nombre-periodo-${id}`).value || `Periodo #${id}`;
                    errorDiv.innerHTML += `Por favor, ingresa ambas fechas para el periodo: "${nombreRef}".<br>`;
                    erroresEncontrados = true;
                    return;
                }

                const fechaInicio = new Date(inputIngreso + 'T00:00:00');
                const fechaFin = new Date(inputCalculo + 'T00:00:00');

                if (fechaInicio > fechaFin) {
                    errorDiv.innerHTML += `La Fecha de Inicio no puede ser posterior a la Fecha de Fin para el periodo: "${nombrePeriodo}".<br>`;
                    erroresEncontrados = true;
                    return;
                }

                // Calcular la diferencia para el periodo individual
                const diferencia = calcularDiferencia(fechaInicio, fechaFin);

                // Acumular totales
                totalAnos += diferencia.anos;
                totalMeses += diferencia.meses;
                totalDias += diferencia.dias;

                const anosTexto = diferencia.anos === 1 ? 'año' : 'años';
                const mesesTexto = diferencia.meses === 1 ? 'mes' : 'meses';
                const diasTexto = diferencia.dias === 1 ? 'día' : 'días';
                
                // HTML para resultados individuales (presentación horizontal compacta)
                resultadosHTML += `
                    <div class="flex flex-col sm:flex-row items-center p-3 bg-white rounded-lg shadow-md border-l-4 border-emerald-400">
                        <span class="font-semibold text-gray-700 w-full sm:w-1/4 mb-2 sm:mb-0">${nombrePeriodo} (${inputIngreso} a ${inputCalculo}):</span>
                        <div class="flex justify-around flex-grow space-x-2 w-full sm:w-3/4">
                            <span class="text-sm font-bold text-emerald-600 whitespace-nowrap">${diferencia.anos} ${anosTexto}</span>
                            <span class="text-sm font-bold text-emerald-600 whitespace-nowrap">${diferencia.meses} ${mesesTexto}</span>
                            <span class="text-sm font-bold text-emerald-600 whitespace-nowrap">${diferencia.dias} ${diasTexto}</span>
                        </div>
                    </div>
                `;
            });

            if (erroresEncontrados) {
                errorDiv.classList.remove('hidden');
                return;
            }

            // Normalizar el tiempo total acumulado
            const totalNormalizado = normalizarTiempo(totalDias, totalMeses, totalAnos);
            
            const totalAnosTexto = totalNormalizado.anos === 1 ? 'año' : 'años';
            const totalMesesTexto = totalNormalizado.meses === 1 ? 'mes' : 'meses';
            const totalDiasTexto = totalNormalizado.dias === 1 ? 'día' : 'días';
            
            // HTML para el resultado total (destacado)
            const totalHTML = `
                <h3 class="text-2xl font-extrabold mb-4 text-white text-center">TIEMPO TOTAL ACUMULADO</h3>
                <div class="flex flex-col md:flex-row justify-around items-center space-y-4 md:space-y-0 text-center">
                    <!-- Años Totales -->
                    <div class="p-3">
                        <p class="text-6xl font-extrabold text-white">${totalNormalizado.anos}</p>
                        <p class="text-lg font-semibold text-emerald-100 mt-1">${totalAnosTexto.toUpperCase()}</p>
                    </div>
                    <!-- Meses Totales -->
                    <div class="p-3">
                        <p class="text-6xl font-extrabold text-white">${totalNormalizado.meses}</p>
                        <p class="text-lg font-semibold text-emerald-100 mt-1">${totalMesesTexto.toUpperCase()}</p>
                    </div>
                    <!-- Días Totales -->
                    <div class="p-3">
                        <p class="text-6xl font-extrabold text-white">${totalNormalizado.dias}</p>
                        <p class="text-lg font-semibold text-emerald-100 mt-1">${totalDiasTexto.toUpperCase()}</p>
                    </div>
                </div>
            `;
            
            resultadosIndividualesDiv.innerHTML = resultadosHTML;
            resultadoTotalDiv.innerHTML = totalHTML;
            resultadoContainer.classList.remove('hidden');
            postCalculoActions.classList.remove('hidden'); // Mostrar solo el botón TERMINAR
        }
    </script>

</body>
</html>